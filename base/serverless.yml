service: binge-baboon-service

provider:
  name: aws
  runtime: python3.10
  region: eu-central-1
  stage: dev
  memorySize: 128
  timeout: 10

functions:
  hello:
    handler: api-gateway/handler.hello
    package:
      include:
        - hello/**
    events:
      - http:
          path: hello
          method: get
          cors:
            origins:
              - '*'
            headers:
              - Authorization
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayCognitoAuthorizer

resources:
  Resources:
    CognitoUserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        UserPoolName: binge-baboon-users2
        AutoVerifiedAttributes:
          - email
        UsernameAttributes:
          - email
        MfaConfiguration: 'OFF'
        Policies:
          PasswordPolicy:
            MinimumLength: 8
            RequireUppercase: true
            RequireLowercase: true
            RequireNumbers: true
            RequireSymbols: true
        EmailConfiguration:
          EmailSendingAccount: COGNITO_DEFAULT

    CognitoUserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      Properties:
        ClientName: binge-baboon
        UserPoolId:
          Ref: CognitoUserPool
        GenerateSecret: false
        ExplicitAuthFlows:
          - ALLOW_USER_SRP_AUTH
          - ALLOW_REFRESH_TOKEN_AUTH

    ApiGatewayCognitoAuthorizer:
      Type: AWS::ApiGateway::Authorizer
      Properties:
        Name: bingeBaboonAuthorizer
        IdentitySource: method.request.header.Authorization
        RestApiId:
          Ref: ApiGatewayRestApi
        Type: COGNITO_USER_POOLS
        ProviderARNs:
          - Fn::GetAtt:
              - CognitoUserPool
              - Arn

  Outputs:
    CognitoUserPoolId:
      Description: "Cognito User Pool ID"
      Value:
        Ref: CognitoUserPool
    CognitoUserPoolClientId:
      Description: "Cognito User Pool Client ID"
      Value:
        Ref: CognitoUserPoolClient
    ApiGatewayRestApiId:
      Description: "API Gateway Rest API ID"
      Value:
        Ref: ApiGatewayRestApi
    ApiGatewayRestApiRootResourceId:
      Description: "API Gateway Rest API Root Resource ID"
      Value:
        Fn::GetAtt:
          - ApiGatewayRestApi
          - RootResourceId
